---
# openvswitch role - modernized for Ubuntu 22.04+ / Debian 12+
#
# Changes from legacy version:
#   - Use system packages instead of building from source
#   - Ubuntu 22.04 provides OVS 2.17+ which is much newer than legacy 2.4.0
#   - Removed python-openvswitch (Python 2) - use python3-openvswitch instead
#   - Updated Ansible syntax to modern FQCN format
#
# The apt role already installs openvswitch-switch and openvswitch-common.
# This role ensures the service is running and verifies the installation.

- name: Ensure Open vSwitch packages are installed
  ansible.builtin.apt:
    name:
      - openvswitch-switch
      - openvswitch-common
    state: present
  tags: openvswitch

- name: Ensure Open vSwitch service is started and enabled
  ansible.builtin.service:
    name: openvswitch-switch
    state: started
    enabled: yes
  tags: openvswitch

- name: Check Open vSwitch version
  ansible.builtin.command: "ovs-vsctl --version"
  register: ovsdb_version
  changed_when: false
  tags: openvswitch

- name: Check Open vSwitch daemon status
  ansible.builtin.command: "ovs-vsctl show"
  register: ovs_status
  changed_when: false
  ignore_errors: yes
  tags: openvswitch

- name: Display Open vSwitch status
  ansible.builtin.debug:
    msg: |
      Open vSwitch installation status:
        - Version: {{ ovsdb_version.stdout_lines[0] | default('unknown') }}
        - Status: {{ 'Running' if ovs_status.rc == 0 else 'Not running or error' }}

      Note: Using system OVS package instead of building from source.
      Ubuntu 22.04 provides OVS 2.17+, which is newer than legacy 2.4.0.
  tags: openvswitch

# Legacy tasks removed:
# - Download and build OVS from source (unnecessary, system packages are fine)
# - Install python-openvswitch (Python 2 only, not available on modern systems)
# - Complex cleanup of build artifacts