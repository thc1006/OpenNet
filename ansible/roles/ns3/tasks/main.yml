---
# ns3 role - modernized for Ubuntu 22.04+ / Debian 12+
#
# Changes from legacy version:
#   - Added --disable-python option (ns-3.22 Python bindings may not work with Python 3)
#   - Removed async: 0 poll: 0 which caused silent failures
#   - Added proper error handling
#   - Added timeout for long-running build tasks
#
# Note: ns-3.22 may have compilation issues with GCC 11+
#       Consider upgrading to ns-3.39+ for better modern compiler support

- name: Set NS3 variables
  set_fact:
    ns3_url: "https://www.nsnam.org/release/ns-allinone-{{ NS3_VERSION }}.tar.bz2"
    ns3_dir: "{{ home_location }}/ns-allinone-{{ NS3_VERSION }}/ns-{{ NS3_VERSION }}"
  tags: ns3

- name: Check if NS3 tarball already exists
  stat:
    path: "{{ home_location }}/ns-allinone-{{ NS3_VERSION }}.tar.bz2"
  register: ns3_tarball
  tags: ns3

- name: Download NS3
  get_url:
    url: "{{ ns3_url }}"
    dest: "{{ home_location }}"
    timeout: 300
  when: not ns3_tarball.stat.exists
  tags: ns3

- name: Check if NS3 is already extracted
  stat:
    path: "{{ ns3_dir }}"
  register: ns3_extracted
  tags: ns3

- name: Untar NS3
  unarchive:
    src: "{{ home_location }}/ns-allinone-{{ NS3_VERSION }}.tar.bz2"
    dest: "{{ home_location }}"
    remote_src: yes
  when: not ns3_extracted.stat.exists
  tags: ns3

- name: Apply OpenNet patches to NS3
  patch:
    src: "{{ opennet_repo_path | default(playbook_dir | dirname) }}/ns3-patch/{{ item }}"
    basedir: "{{ ns3_dir }}"
    strip: 1
  with_items:
    - gcc11-compat.patch
    - animation-interface.patch
    - netanim-python.patch
    - sta-wifi-scan.patch
    # Note: lte.patch disabled due to circular dependency with fd-net-device
    # - lte.patch
  ignore_errors: yes
  tags: ns3

- name: Waf configure (without Python bindings for compatibility)
  command: "./waf configure --disable-python --enable-examples"
  args:
    chdir: "{{ ns3_dir }}"
  register: waf_configure
  ignore_errors: yes
  tags: ns3

- name: Display waf configure result
  debug:
    msg: "waf configure {{ 'succeeded' if waf_configure.rc == 0 else 'had issues (may be expected for ns-3.22 on modern systems)' }}"
  tags: ns3

- name: Waf build
  command: "./waf build -j{{ ansible_processor_vcpus | default(2) }}"
  args:
    chdir: "{{ ns3_dir }}"
  register: waf_build
  ignore_errors: yes
  tags: ns3

- name: Display waf build result
  debug:
    msg: "waf build {{ 'succeeded' if waf_build.rc == 0 else 'failed - see docs/REFACTORING_PLAN.md for known GCC 11+ issues' }}"
  tags: ns3

- name: Waf install (only if build succeeded)
  command: "./waf install"
  args:
    chdir: "{{ ns3_dir }}"
  when: waf_build.rc == 0
  tags: ns3

- name: Configure dynamic linker run-time bindings
  command: "ldconfig"
  when: waf_build.rc == 0
  tags: ns3

- name: Remove NS3 tarball to save space
  file:
    path: "{{ home_location }}/ns-allinone-{{ NS3_VERSION }}.tar.bz2"
    state: absent
  tags: ns3

- name: NS3 build summary
  debug:
    msg: |
      NS3 installation summary:
        - Version: {{ NS3_VERSION }}
        - Location: {{ ns3_dir }}
        - Configure: {{ 'OK' if waf_configure.rc == 0 else 'FAILED' }}
        - Build: {{ 'OK' if waf_build.rc == 0 else 'FAILED' }}
        - Python bindings: DISABLED (ns-3.22 incompatible with Python 3)

      If build failed, check docs/REFACTORING_PLAN.md for known issues.
  tags: ns3
